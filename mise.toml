[tools]
go = "1.25.6"
golangci-lint = "latest"

[tasks.install]
run = "go mod download"

[tasks.'lint:golangci-lint']
run = "golangci-lint run"

[tasks.lint]
depends = ["lint:*"]

[tasks.'fmt:go']
run = "go fmt ./..."

[tasks.fmt]
depends = ["fmt:*"]

[tasks.test]
run = "go test -count=1 ./..."

[tasks.codegen]
run = """
go generate ./...
go mod tidy
"""

[tasks.build]
run = """
#!/usr/bin/env bash
mkdir -p build
go tool dist list | grep -vE 'wasm|aix|plan9|android|ios|illumos|solaris|dragonfly' | while IFS=/ read -r GOOS GOARCH; do
  echo "Building $GOOS/$GOARCH"
  GOOS=$GOOS GOARCH=$GOARCH go build -v -o build/ts-proxyd-$GOOS-$GOARCH ./cmd/ts-proxyd
done
"""

[tasks.'docker:build']
run = "docker build -t ts-proxyd ."

[tasks.'docker:push']
run = "echo 'Docker push should be handled in CI with proper credentials'"

[tasks.ci]
depends = ["lint", "test", "build"]
